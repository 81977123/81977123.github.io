# ROS1麦轮小车STM32代码讲解教程

## 项目概述

本项目是一个基于STM32F103微控制器的ROS1麦轮小车底层驱动代码。该代码负责小车的底层硬件控制，包括电机驱动、传感器数据采集、运动学计算以及与ROS系统的通信。

### 硬件平台
- **主控芯片**: STM32F103系列（具体型号可能为STM32F103RC）
- **电机类型**: 直流有刷电机或直流无刷电机（带编码器）
- **轮子类型**: 麦克纳姆轮（Mecanum Wheel），共4个
- **传感器**: 
  - MPU6050（六轴陀螺仪加速度计）
  - 编码器（用于电机转速测量）
  - 电池电压检测
- **通信接口**:
  - 蓝牙模块（用于无线控制）
  - UART串口（与ROS主控通信）

## 项目目录结构

```
Program - IMU 和蓝牙- 新版光编编码电机2022.12.16/
├── Drivers/           # STM32 HAL库和CMSIS库
├── Inc/              # 头文件目录
│   ├── main.h        # 主头文件
│   ├── Kinematics_Mecanum.h  # 麦轮运动学计算
│   ├── MotorControl.h        # 电机控制
│   ├── Encoder.h             # 编码器接口
│   ├── mpu6050.h             # MPU6050传感器
│   ├── pid.h                 # PID控制器
│   ├── Bluetooth.h           # 蓝牙通信
│   ├── DataProtocol.h        # 数据协议
│   └── ... 其他头文件
├── Src/              # 源文件目录
│   ├── main.c        # 主程序
│   ├── Kinematics_Mecanum.c  # 运动学实现
│   ├── MotorControl.c        # 电机控制实现
│   ├── Encoder.c             # 编码器实现
│   ├── mpu6050.c             # MPU6050驱动
│   ├── pid.c                 # PID算法
│   └── ... 其他源文件
└── MDK-ARM/          # Keil MDK工程文件
```

## 核心模块详解

### 1. 运动学模块 (Kinematics_Mecanum)

麦轮小车使用四个麦克纳姆轮，每个轮子都可以独立控制。运动学模块负责将小车的整体运动指令分解为四个电机的转速指令。

#### 关键参数
- `WHEEL_CIRCUMFERENCE`: 轮子周长 (0.477522m)
- `LR_WHEELS_DISTANCE`: 左右轮距 (0.320m)
- `FR_WHEELS_DISTANCE`: 前后轮距 (0.350m)

#### 运动学结构体
```c
typedef struct
{
    __IO float Linear_X;    // X方向线速度 m/s
    __IO float Linear_Y;    // Y方向线速度 m/s
    __IO float Angular_Z;   // Z轴角速度 rad/s
    __IO float M1_RPM;      // M1电机转速 rpm
    __IO float M2_RPM;      // M2电机转速 rpm
    __IO float M3_RPM;      // M3电机转速 rpm
    __IO float M4_RPM;      // M4电机转速 rpm
} Kinematics_Struct;
```

#### 核心函数
1. `Kinematics_Mecanum_CalculateRPM()`: 正运动学计算
   - 输入：线速度(X,Y)和角速度(Z)
   - 输出：四个电机的RPM值
   - 公式：基于麦轮运动学矩阵

2. `Kinematics_Mecanum_GetVelocities()`: 逆运动学计算
   - 输入：四个电机的RPM值
   - 输出：小车的实际线速度和角速度

### 2. PID控制模块 (pid.h/c)

项目实现了两种PID控制器：增量式PID和位置式PID。

#### 增量式PID结构体
```c
typedef struct
{
    __IO float Proportion;  // 比例系数
    __IO float Integral;    // 积分系数
    __IO float Derivative;  // 微分系数
    
    __IO float Error;       // E(k)当前误差
    __IO float PrevError;   // E(k-1)上一次误差
    __IO float LastError;   // E(k-2)上上次误差
} IncPID_Struct;
```

#### 位置式PID结构体
```c
typedef struct
{
    __IO float Proportion;  // 比例系数
    __IO float Integral;    // 积分系数
    __IO float Derivative;  // 微分系数
    
    __IO float Error;       // E(k)当前误差
    __IO float PrevError;   // E(k-1)上一次误差
    
    __IO float IntegralError;      // 累计积分值
    __IO float IntegralError_Min;  // 积分限幅最小值
    __IO float IntegralError_Max;  // 积分限幅最大值
} PosPID_Struct;
```

#### 应用场景
- **速度控制**: 使用增量式PID控制电机转速
- **位置控制**: 使用位置式PID控制电机位置（如转向角度）

### 3. 电机控制模块 (MotorControl)

电机控制模块负责：
1. PWM信号生成（通过定时器）
2. 电机方向控制（通过GPIO）
3. 电机使能/失能控制
4. 电流/电压保护

#### 控制流程
```
目标速度 → PID控制器 → PWM占空比 → 电机驱动 → 实际速度
      ↑                                    ↓
      └────── 编码器反馈 ────────────────┘
```

### 4. 编码器模块 (Encoder)

编码器用于测量电机实际转速，提供闭环控制的反馈信号。

#### 关键技术
- 使用定时器的编码器模式
- 四倍频计数提高精度
- 速度计算（脉冲数/时间）
- 方向判断

### 5. IMU模块 (mpu6050)

MPU6050提供小车的姿态信息，用于：
1. 姿态稳定控制
2. 导航和定位
3. 运动状态监测

#### 功能
- 读取加速度计数据（X,Y,Z轴）
- 读取陀螺仪数据（角速度）
- 温度读取
- 数据滤波（卡尔曼滤波或互补滤波）

### 6. 通信模块

#### 蓝牙通信 (Bluetooth)
- 使用UART接口与蓝牙模块通信
- 接收来自手机或电脑的控制指令
- 发送小车状态数据

#### 数据协议 (DataProtocol)
- 定义与ROS通信的数据格式
- 数据打包/解包
- 校验和计算

#### 典型数据帧格式
```
[帧头][数据长度][命令字][数据内容][校验和][帧尾]
```

### 7. 电池管理 (BatteryInfor)

- 电池电压检测（通过ADC）
- 电量计算和显示
- 低电压保护
- 充电状态监测

## 系统工作流程

### 主循环 (main.c)
```c
int main(void)
{
    // 1. 系统初始化
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();
    MX_TIM_Init();      // 定时器初始化（PWM、编码器）
    MX_USART_Init();    // 串口初始化
    MX_I2C_Init();      // I2C初始化（MPU6050）
    MX_ADC_Init();      // ADC初始化（电池检测）
    
    // 2. 模块初始化
    Encoder_Init();
    Motor_Init();
    MPU6050_Init();
    Bluetooth_Init();
    PID_Init();
    
    // 3. 主循环
    while (1)
    {
        // 3.1 读取传感器数据
        Read_Encoder_Values();      // 编码器读数
        Read_MPU6050_Data();        // IMU数据
        Read_Battery_Voltage();     // 电池电压
        
        // 3.2 处理通信数据
        Bluetooth_Process();        // 蓝牙指令处理
        ROS_Data_Process();         // ROS指令处理
        
        // 3.3 运动控制
        Kinematics_Calculate();     // 运动学计算
        PID_Control();              // PID控制计算
        Motor_Update();             // 更新电机输出
        
        // 3.4 状态反馈
        Send_Status_Data();         // 发送状态到ROS
        
        // 3.5 系统维护
        Watchdog_Refresh();         // 看门狗喂狗
        Error_Handler();            // 错误处理
    }
}
```

## ROS通信接口

### 数据流
```
ROS节点 (上位机)
    ↓ (UART/USB)
STM32 (下位机)
    ↓
电机/传感器
```

### 典型ROS消息
1. **控制指令** (`geometry_msgs/Twist`)
   - linear.x: 前进/后退速度
   - linear.y: 左/右平移速度
   - angular.z: 旋转角速度

2. **状态反馈** (自定义消息)
   - 电机转速
   - 电池电量
   - IMU数据
   - 编码器计数

### 通信协议
项目可能使用以下协议之一：
1. **自定义二进制协议**: 高效但需要解析
2. **ASCII协议**: 可读性好但效率低
3. **MAVLink协议**: 无人机常用，功能丰富

## 调试与测试

### 1. 硬件调试
- **电机测试**: 单独测试每个电机正反转
- **编码器测试**: 旋转电机观察编码器计数
- **IMU测试**: 静止和运动状态下的数据读取
- **通信测试**: 发送接收测试数据

### 2. 软件调试
- **PID参数整定**: 使用试凑法或Ziegler-Nichols方法
- **运动学验证**: 测试各个方向的运动是否正确
- **系统集成**: 逐步添加模块测试

### 3. 常见问题
1. **电机抖动**: PID参数不合适，尝试调整P值
2. **运动偏差**: 运动学参数不准确，重新测量轮距
3. **通信丢包**: 检查波特率设置和线缆连接
4. **IMU漂移**: 需要校准或使用更好的滤波算法

## 开发环境搭建

### 1. 软件需求
- **IDE**: Keil MDK-ARM 或 STM32CubeIDE
- **编译器**: ARM GCC 或 ARMCC
- **调试器**: J-Link, ST-Link
- **串口工具**: Putty, Tera Term

### 2. 编译步骤
```bash
# 使用Keil MDK
1. 打开 MDK-ARM/STM32F103.uvprojx
2. 配置目标芯片 (STM32F103RC)
3. 设置编译选项
4. 编译项目
5. 下载到开发板
```

### 3. 烧录方法
1. **ST-Link Utility**: 通过ST-Link下载
2. **Keil MDK**: 集成下载功能
3. **串口ISP**: 使用Bootloader模式

## 进阶功能扩展

### 1. 添加新传感器
1. 在`Inc/`目录添加头文件
2. 在`Src/`目录添加驱动代码
3. 在`main.c`中初始化和调用

### 2. 优化性能
1. **中断优化**: 将耗时操作移到主循环
2. **内存优化**: 使用DMA传输数据
3. **算法优化**: 使用定点数运算替代浮点数

### 3. 安全功能
1. **急停功能**: 紧急情况下停止所有电机
2. **碰撞检测**: 添加红外或超声波传感器
3. **故障诊断**: 实时监测系统状态

## 学习资源

### 1. 基础知识
- **STM32编程**: 《STM32库开发实战指南》
- **嵌入式C语言**: 《C Primer Plus》
- **ROS入门**: 《ROS机器人编程》

### 2. 在线资源
- **ST官网**: 数据手册、参考手册、应用笔记
- **GitHub**: 开源STM32项目参考
- **论坛**: 21ic, 电子工程世界, Stack Overflow

### 3. 实践项目
1. **基础**: LED闪烁、按键检测
2. **中级**: PWM控制、串口通信
3. **高级**: 电机控制、传感器融合

## 总结

本项目是一个完整的麦轮小车底层控制系统，涵盖了嵌入式开发的多个方面：
- **硬件驱动**: GPIO、定时器、ADC、I2C、UART
- **控制算法**: PID控制、运动学计算
- **传感器融合**: 编码器+IMU数据融合
- **通信协议**: 与ROS系统的数据交换

对于初学者，建议从理解各个模块的功能开始，逐步深入代码实现细节。可以先尝试修改PID参数观察电机响应，然后理解运动学计算原理，最后掌握整个系统的数据流和控制逻辑。

通过本项目，你可以学习到：
1. STM32嵌入式系统开发
2. 电机控制原理与实践
3. 机器人运动学基础
4. 传感器数据采集与处理
5. 实时系统设计与实现

祝学习顺利！