# ROS1麦轮小车STM32代码快速入门指南

## 一、项目快速了解

### 1.1 项目是什么？
这是一个用于控制四轮麦轮小车的STM32底层驱动代码，可以与ROS1系统配合使用，实现机器人运动控制。

### 1.2 核心功能
- ✅ 控制4个麦克纳姆轮独立运动
- ✅ 读取编码器获取电机转速
- ✅ MPU6050姿态传感器数据采集
- ✅ PID速度控制
- ✅ 蓝牙无线控制
- ✅ 电池电压监测

## 二、5分钟看懂代码结构

### 2.1 最重要的3个文件
1. **`main.c`** - 程序入口，主循环在这里
2. **`Kinematics_Mecanum.c/h`** - 运动学计算核心
3. **`MotorControl.c/h`** - 电机控制核心

### 2.2 数据流向（简化版）
```
蓝牙/ROS指令 → 运动学计算 → PID控制 → 电机PWM
                                    ↓
编码器反馈 ←───────────────────────┘
```

## 三、如何开始测试

### 3.1 硬件连接检查
1. **电源**: 12V电池接入
2. **电机**: 4个电机接线正确
3. **编码器**: 编码器线连接
4. **蓝牙**: 蓝牙模块接UART
5. **IMU**: MPU6050接I2C

### 3.2 软件测试步骤

#### 步骤1：编译下载
```bash
# 使用Keil MDK
1. 打开 MDK-ARM/STM32F103.uvprojx
2. 点击"Rebuild"编译
3. 点击"Download"下载到开发板
```

#### 步骤2：基础测试
```c
// 测试单个电机（修改MotorControl.c）
Motor_SetSpeed(0, 1000);  // 电机0，1000RPM
HAL_Delay(2000);
Motor_SetSpeed(0, 0);     // 停止
```

#### 步骤3：运动测试
```c
// 测试前进（修改main.c）
Kinematics.Linear_X = 0.5;  // 0.5m/s前进
Kinematics.Linear_Y = 0.0;  // 无横向移动
Kinematics.Angular_Z = 0.0; // 无旋转
Kinematics_Mecanum_CalculateRPM(&Kinematics);
```

## 四、关键参数调整

### 4.1 PID参数（pid.h）
```c
// 初始值（可能需要调整）
#define P_GAIN 0.5
#define I_GAIN 0.1
#define D_GAIN 0.05
```

**调整技巧**：
- **电机抖动** → 减小P值
- **响应慢** → 增大P值
- **稳态误差** → 增大I值
- **超调大** → 增大D值

### 4.2 运动学参数（Kinematics_Mecanum.h）
```c
#define WHEEL_CIRCUMFERENCE 0.477522f  // 轮子周长(m)
#define LR_WHEELS_DISTANCE 0.320f      // 左右轮距(m)
#define FR_WHEELS_DISTANCE 0.350f      // 前后轮距(m)
```

**测量方法**：
1. 用卷尺测量实际轮距
2. 计算轮子周长 = π × 直径
3. 更新参数后重新编译

## 五、常见问题解决

### 5.1 电机不转
1. **检查电源**：万用表测量电压
2. **检查PWM输出**：示波器看波形
3. **检查使能信号**：GPIO电平

### 5.2 编码器读数异常
1. **检查接线**：A相、B相、VCC、GND
2. **检查配置**：定时器编码器模式
3. **测试方法**：手动转动电机观察计数

### 5.3 蓝牙连接失败
1. **检查波特率**：确保与模块一致
2. **检查AT指令**：蓝牙模块需要正确配置
3. **测试通信**：用串口助手测试

### 5.4 IMU数据异常
1. **检查I2C地址**：MPU6050地址0x68或0x69
2. **检查初始化**：正确配置采样率、量程
3. **校准传感器**：水平静止状态校准

## 六、与ROS通信

### 6.1 数据格式示例
```c
// 发送到ROS的数据包
typedef struct {
    float velocity_x;      // X方向速度
    float velocity_y;      // Y方向速度
    float angular_z;       // 角速度
    float battery_voltage; // 电池电压
    uint16_t encoder[4];   // 4个编码器值
} ROS_Data_Packet;
```

### 6.2 简单测试程序
```python
# Python串口测试（在ROS节点之前测试）
import serial
import time

ser = serial.Serial('/dev/ttyUSB0', 115200, timeout=1)

# 发送前进指令
command = b'\x01\x00\x00\x00\x00\x00'  # 简单协议示例
ser.write(command)

# 接收数据
response = ser.read(20)
print("Received:", response)
```

## 七、下一步学习建议

### 7.1 初学者路线
1. **第1周**：理解main.c流程，测试单个电机
2. **第2周**：学习PID原理，调整参数
3. **第3周**：理解运动学，测试各种运动
4. **第4周**：集成所有功能，与ROS通信

### 7.2 进阶学习
1. **代码优化**：使用DMA、中断优化性能
2. **添加功能**：避障传感器、摄像头
3. **算法改进**：自适应PID、滑模控制
4. **系统集成**：与SLAM、导航算法结合

## 八、实用工具推荐

### 8.1 开发工具
- **串口调试**：Putty、SecureCRT
- **逻辑分析仪**：Saleae Logic（分析PWM、编码器）
- **示波器**：观察电源纹波、信号质量

### 8.2 测试工具
- **手机APP**：蓝牙调试助手
- **ROS工具**：rostopic, rqt_plot
- **数据分析**：Python + matplotlib

## 九、紧急情况处理

### 9.1 小车失控
1. **立即断电**：拔掉电池
2. **检查程序**：是否有死循环
3. **安全模式**：添加急停开关

### 9.2 冒烟/发热
1. **立即断电**！
2. **检查短路**：万用表测量
3. **更换损坏元件**：电机驱动芯片、MOS管

### 9.3 程序无法下载
1. **检查Boot0**：设置为0（运行模式）
2. **检查复位电路**：按下复位按钮
3. **更换下载器**：尝试不同的ST-Link

## 十、获取帮助

### 10.1 项目内资源
- 查看代码注释（中英文混合）
- 参考`Inc/`目录下的头文件说明
- 查看编译生成的`.map`文件了解内存使用

### 10.2 外部资源
- **STM32官方**：www.st.com
- **ROS社区**：answers.ros.org
- **GitHub**：搜索类似项目参考

### 10.3 调试技巧
1. **LED指示**：用LED显示程序状态
2. **串口打印**：关键变量输出到串口
3. **分段测试**：每次只测试一个功能
4. **对比测试**：与正常工作代码对比

---

**记住**：嵌入式开发需要耐心，遇到问题是正常的。从简单开始，逐步验证每个模块，最终一定能让小车跑起来！

**祝你好运！** 🚀