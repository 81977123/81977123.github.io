<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åšå®¢æ–‡æ¡£æ ‘çŠ¶å›¾ - å¾è¾°çš„åšå®¢</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: "Microsoft YaHei", "Inter", sans-serif;
            background-color: #f8fafc;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            max-width: 1000px;
            width: 100%;
        }
        .title {
            font-size: 42px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 18px;
            color: #64748b;
            margin-bottom: 20px;
        }
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .btn {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .btn.secondary {
            background: #94a3b8;
        }
        .btn.secondary:hover {
            background: #64748b;
        }
        .search-box {
            padding: 10px 15px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
            width: 300px;
            transition: border-color 0.2s;
        }
        .search-box:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            width: 100%;
            max-width: 1400px;
            min-height: 800px;
            overflow: auto;
        }
        .link {
            fill: none;
            stroke: #3b82f6;
            stroke-opacity: 0.8;
            cursor: pointer;
            transition: stroke-width 0.2s;
        }
        .link:hover {
            stroke-opacity: 1;
        }
        .node-circle {
            fill: #3b82f6;
            stroke: #ffffff;
            stroke-width: 3px;
            cursor: pointer;
            transition: r 0.2s;
        }
        .node-circle.directory {
            fill: #10b981;
        }
        .node-circle.file {
            fill: #f59e0b;
        }
        .node-circle.root {
            fill: #8b5cf6;
            stroke-width: 4px;
        }
        .node-label {
            font-size: 16px;
            fill: #1e293b;
            font-weight: 500;
            cursor: pointer;
            pointer-events: none;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 6px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            z-index: 100;
        }
        .legend {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #475569;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        .legend-color.directory {
            background: #10b981;
        }
        .legend-color.file {
            background: #f59e0b;
        }
        .legend-color.root {
            background: #8b5cf6;
        }
        footer {
            margin-top: 30px;
            text-align: center;
            color: #64748b;
            font-size: 14px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">ğŸ“š åšå®¢æ–‡æ¡£æ ‘çŠ¶å›¾</h1>
        <p class="subtitle">å¯è§†åŒ–å±•ç¤º docs/ ç›®å½•ä¸‹çš„æ–‡æ¡£ç»“æ„ï¼Œç‚¹å‡»èŠ‚ç‚¹æˆ–è¿çº¿å¯äº¤äº’</p>
        <div class="controls">
            <input type="text" class="search-box" placeholder="æœç´¢èŠ‚ç‚¹åç§°..." id="search-input">
            <button class="btn" id="expand-all">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                </svg>
                å…¨éƒ¨å±•å¼€
            </button>
            <button class="btn secondary" id="collapse-all">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
                </svg>
                å…¨éƒ¨æŠ˜å 
            </button>
            <button class="btn secondary" id="toggle-links">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                </svg>
                åˆ‡æ¢è¿çº¿
            </button>
        </div>
    </div>

    <div class="container">
        <svg id="tree-svg" width="100%" height="700"></svg>
    </div>

    <div class="legend">
        <div class="legend-item">
            <div class="legend-color root"></div>
            <span>æ ¹ç›®å½•</span>
        </div>
        <div class="legend-item">
            <div class="legend-color directory"></div>
            <span>æ–‡ä»¶å¤¹</span>
        </div>
        <div class="legend-item">
            <div class="legend-color file"></div>
            <span>æ–‡ä»¶</span>
        </div>
        <div class="legend-item">
            <div style="width: 16px; height: 16px; background: #3b82f6; border-radius: 2px;"></div>
            <span>è¿çº¿ç²—ç»†è¡¨ç¤ºå­èŠ‚ç‚¹æ•°é‡</span>
        </div>
    </div>

    <footer>
        <p>Â© 2026 å¾è¾°çš„åšå®¢ | æ ‘çŠ¶å›¾ä½¿ç”¨ D3.js ç»˜åˆ¶ | æ•°æ®åŸºäº docs/ ç›®å½•å®æ—¶ç”Ÿæˆ</p>
        <p>æç¤ºï¼šç‚¹å‡»æ–‡ä»¶å¤¹èŠ‚ç‚¹å¯å±•å¼€/æŠ˜å ï¼Œç‚¹å‡»æ–‡ä»¶èŠ‚ç‚¹æˆ–è¿çº¿å¯è·³è½¬åˆ°å¯¹åº”é¡µé¢</p>
    </footer>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // é…ç½®
        const svg = d3.select("#tree-svg");
        const width = svg.node().getBoundingClientRect().width;
        const height = 700;
        svg.attr("viewBox", [0, 0, width, height]);

        const margin = { top: 40, right: 120, bottom: 40, left: 120 };
        const innerWidth = width - margin.left - margin.right;
        const innerHeight = height - margin.top - margin.bottom;

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // æ ‘å¸ƒå±€
        const treeLayout = d3.tree()
            .size([innerHeight, innerWidth])
            .separation((a, b) => a.parent === b.parent ? 1.2 : 2);

        // ç¼©æ”¾è¡Œä¸º
        const zoom = d3.zoom()
            .scaleExtent([0.1, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });
        svg.call(zoom);

        // å·¥å…·æç¤º
        const tooltip = d3.select("#tooltip");

        // åŠ è½½æ•°æ®
        let root = null;
        let treeData = null;

        async function loadData() {
            try {
                const response = await fetch("tree-data-filtered.json");
                const data = await response.json();
                treeData = data.root;
                initializeTree();
            } catch (error) {
                console.error("åŠ è½½æ•°æ®å¤±è´¥:", error);
                g.append("text")
                    .attr("x", innerWidth / 2)
                    .attr("y", innerHeight / 2)
                    .attr("text-anchor", "middle")
                    .text("æ— æ³•åŠ è½½æ ‘çŠ¶æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é‡æ–°ç”Ÿæˆæ•°æ®ã€‚");
            }
        }

        // è®¡ç®—æƒé‡ï¼ˆåä»£æ–‡ä»¶æ•°é‡ï¼‰
        function computeWeight(node) {
            if (!node.children || node.children.length === 0) {
                node.weight = (node.data.type === 'file') ? 1 : 0;
                return node.weight;
            }
            let total = 0;
            node.children.forEach(child => {
                total += computeWeight(child);
            });
            node.weight = total;
            return total;
        }

        // åˆå§‹åŒ–æ ‘
        function initializeTree() {
            // è½¬æ¢æ•°æ®ä¸ºD3å±‚æ¬¡ç»“æ„
            root = d3.hierarchy(treeData, d => d.children);
            root.x0 = innerHeight / 2;
            root.y0 = 0;

            // è®¡ç®—æƒé‡
            computeWeight(root);

            // å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
            root.descendants().forEach(d => {
                d._children = d.children;
                if (d.depth >= 2) d.children = null; // é»˜è®¤æŠ˜å æ·±åº¦å¤§äº1çš„èŠ‚ç‚¹
            });

            update(root);
        }

        // æ›´æ–°æ ‘
        function update(source) {
            const duration = 250;

            // è®¡ç®—æ–°å¸ƒå±€
            treeLayout(root);

            const nodes = root.descendants();
            const links = root.links();

            // èŠ‚ç‚¹ä½ç½®
            nodes.forEach(d => {
                d.y = d.depth * 180; // æ°´å¹³é—´è·
                d.x = d.x; // å‚ç›´ä½ç½®ç”±æ ‘å¸ƒå±€è®¡ç®—
            });

            // é€‰æ‹©é“¾æ¥
            const link = g.selectAll(".link")
                .data(links, d => d.target.id);

            // é“¾æ¥è¿›å…¥
            const linkEnter = link.enter()
                .append("path")
                .attr("class", "link")
                .attr("d", d => diagonal(d.source, d.target))
                .style("opacity", 0)
                .on("click", linkClicked)
                .on("mouseover", linkMouseover)
                .on("mouseout", linkMouseout);

            // é“¾æ¥æ›´æ–°
            link.merge(linkEnter)
                .transition()
                .duration(duration)
                .attr("d", d => diagonal(d.source, d.target))
                .style("opacity", 1)
                .attr("stroke-width", d => {
                    // æ ¹æ®ç›®æ ‡èŠ‚ç‚¹çš„æƒé‡å†³å®šè¿çº¿ç²—ç»†
                    const weight = d.target.weight || 1;
                    // æ˜ å°„æƒé‡åˆ°ç²—ç»†èŒƒå›´ï¼Œä¾‹å¦‚ 1-20
                    const minWeight = 1, maxWeight = root.weight;
                    const minWidth = 2, maxWidth = 20;
                    if (maxWeight <= minWeight) return minWidth;
                    const normalized = (weight - minWeight) / (maxWeight - minWeight);
                    return minWidth + normalized * (maxWidth - minWidth);
                });

            // é“¾æ¥é€€å‡º
            link.exit()
                .transition()
                .duration(duration)
                .style("opacity", 0)
                .remove();

            // é€‰æ‹©èŠ‚ç‚¹
            const node = g.selectAll(".node")
                .data(nodes, d => d.id || (d.id = ++i));

            // èŠ‚ç‚¹è¿›å…¥
            const nodeEnter = node.enter()
                .append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${source.y0},${source.x0})`)
                .on("click", clicked)
                .on("mouseover", showTooltip)
                .on("mouseout", hideTooltip);

            // èŠ‚ç‚¹åœ†åœˆ
            nodeEnter.append("circle")
                .attr("class", d => {
                    let cls = "node-circle";
                    if (d.depth === 0) cls += " root";
                    else if (d.data.type === "directory") cls += " directory";
                    else cls += " file";
                    return cls;
                })
                .attr("r", d => d.depth === 0 ? 20 : (d.data.type === "directory" ? 16 : 12))
                .style("fill", d => {
                    if (d.depth === 0) return "#8b5cf6";
                    return d.data.type === "directory" ? "#10b981" : "#f59e0b";
                });

            // èŠ‚ç‚¹æ ‡ç­¾ï¼ˆä»…æ˜¾ç¤ºåç§°ï¼Œæ— è·¯å¾„ï¼‰
            nodeEnter.append("text")
                .attr("class", "node-label")
                .attr("dy", "0.35em")
                .attr("x", d => d.children || d._children ? -25 : 25)
                .style("text-anchor", d => d.children || d._children ? "end" : "start")
                .text(d => d.data.name);

            // èŠ‚ç‚¹æ›´æ–°
            const nodeUpdate = node.merge(nodeEnter)
                .transition()
                .duration(duration)
                .attr("transform", d => `translate(${d.y},${d.x})`);

            // èŠ‚ç‚¹é€€å‡º
            node.exit()
                .transition()
                .duration(duration)
                .attr("transform", d => `translate(${source.y},${source.x})`)
                .style("opacity", 0)
                .remove();

            // å­˜å‚¨æ—§ä½ç½®
            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });

            // å¯¹è§’çº¿ç”Ÿæˆå™¨ï¼ˆæ›²çº¿ï¼‰
            function diagonal(s, t) {
                return `M ${s.y} ${s.x}
                        C ${(s.y + t.y) / 2} ${s.x},
                          ${(s.y + t.y) / 2} ${t.x},
                          ${t.y} ${t.x}`;
            }
        }

        let i = 0;

        // ç‚¹å‡»èŠ‚ç‚¹
        function clicked(event, d) {
            if (d.data.type === "file") {
                // æ–‡ä»¶ï¼šè·³è½¬
                const urlPath = d.data.path.replace(/\\/g, '/').replace(/\.md$/, '.html');
                const url = urlPath.startsWith('/') ? urlPath : '/' + urlPath;
                window.open(url, '_blank');
                return;
            }
            // æ–‡ä»¶å¤¹ï¼šå±•å¼€/æŠ˜å 
            if (d.children) {
                d._children = d.children;
                d.children = null;
            } else {
                d.children = d._children;
                d._children = null;
            }
            update(d);
        }

        // ç‚¹å‡»è¿çº¿
        function linkClicked(event, d) {
            // è·³è½¬åˆ°ç›®æ ‡èŠ‚ç‚¹ï¼ˆå¦‚æœæ˜¯æ–‡ä»¶ï¼‰æˆ–å±•å¼€/æŠ˜å ç›®å½•
            const target = d.target;
            if (target.data.type === "file") {
                const urlPath = target.data.path.replace(/\\/g, '/').replace(/\.md$/, '.html');
                const url = urlPath.startsWith('/') ? urlPath : '/' + urlPath;
                window.open(url, '_blank');
            } else {
                // å¦‚æœæ˜¯ç›®å½•ï¼Œåˆ‡æ¢å±•å¼€/æŠ˜å 
                if (target.children) {
                    target._children = target.children;
                    target.children = null;
                } else {
                    target.children = target._children;
                    target._children = null;
                }
                update(target);
            }
        }

        // è¿çº¿é¼ æ ‡äº‹ä»¶
        function linkMouseover(event, d) {
            tooltip
                .style("opacity", 1)
                .html(`
                    <strong>${d.target.data.name}</strong><br/>
                    ç±»å‹: ${d.target.data.type === 'directory' ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶'}<br/>
                    æƒé‡: ${d.target.weight || 0} ä¸ªå­æ–‡ä»¶<br/>
                    ç‚¹å‡»è·³è½¬æˆ–å±•å¼€
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function linkMouseout() {
            tooltip.style("opacity", 0);
        }

        // å·¥å…·æç¤º
        function showTooltip(event, d) {
            tooltip
                .style("opacity", 1)
                .html(`
                    <strong>${d.data.name}</strong><br/>
                    ç±»å‹: ${d.data.type === 'directory' ? 'æ–‡ä»¶å¤¹' : 'æ–‡ä»¶'}<br/>
                    æƒé‡: ${d.weight || 0} ä¸ªå­æ–‡ä»¶<br/>
                    ${d.data.type === 'file' ? 'ç‚¹å‡»è·³è½¬åˆ°é¡µé¢' : 'ç‚¹å‡»å±•å¼€/æŠ˜å '}
                `)
                .style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY - 10) + "px");
        }

        function hideTooltip() {
            tooltip.style("opacity", 0);
        }

        // æŒ‰é’®äº‹ä»¶
        document.getElementById("expand-all").addEventListener("click", () => {
            root.descendants().forEach(d => {
                if (d.data.type === "directory" && d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            });
            update(root);
        });

        document.getElementById("collapse-all").addEventListener("click", () => {
            root.descendants().forEach(d => {
                if (d.data.type === "directory" && d.children) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            update(root);
        });

        document.getElementById("toggle-links").addEventListener("click", () => {
            const links = g.selectAll(".link");
            const visible = links.style("opacity") !== "0";
            links.transition().style("opacity", visible ? 0 : 1);
        });

        // æœç´¢
        document.getElementById("search-input").addEventListener("input", function() {
            const term = this.value.trim().toLowerCase();
            if (!term) {
                g.selectAll(".node").style("opacity", 1);
                g.selectAll(".link").style("opacity", 1);
                return;
            }
            g.selectAll(".node").style("opacity", 0.2);
            g.selectAll(".link").style("opacity", 0.1);
            g.selectAll(".node").each(function(d) {
                if (d.data.name.toLowerCase().includes(term)) {
                    d3.select(this).style("opacity", 1);
                    // é«˜äº®ç›¸å…³è¿çº¿
                    d3.selectAll(".link").filter(l => l.target === d || l.source === d)
                        .style("opacity", 1);
                }
            });
        });

        // åˆå§‹åŒ–
        loadData();
    </script>
</body>
</html>